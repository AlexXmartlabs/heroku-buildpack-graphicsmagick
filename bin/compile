#!/bin/bash

set -e

source `dirname $0`/../configs.sh

# parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2
LP_DIR=`cd $(dirname $0); cd ..; pwd`

indent() {
  sed -u 's/^/       /'
}

arrow() {
  sed -u 's/^/-----> /'
}

function mktmpdir() {
  dir=$(mktemp -t graphicsmagick-$1-XXXX)
  rm -rf $dir
  mkdir -p $dir
  echo $dir
}

echo "Installing graphicsmagick $GRAPHICS_MAGICK_VERSION" | arrow

# we need this directory, it's our destination
gm_lib_path=$BUILD_DIR/vendor/graphicsmagick
mkdir -p $gm_lib_path

GM_SOURCE="$(mktemp -t graphicsmagick_XXXXX)"
rm -rf $GM_SOURCE
mkdir -p $GM_SOURCE
echo $GM_SOURCE

package="https://downloads.sourceforge.net/project/graphicsmagick/graphicsmagick/$GRAPHICS_MAGICK_VERSION/GraphicsMagick-$GRAPHICS_MAGICK_VERSION.tar.gz"

curl $package -L -o - | tar xzf - -C $GM_SOURCE
cd $GM_SOURCE/GraphicsMagick-$GRAPHICS_MAGICK_VERSION

echo "Building runtime environment for graphicsmagick" | arrow
echo "This may take a while" | indent
./configure --prefix=$gm_lib_path && make install

cd $gm_lib_path
mkdir -p "$BUILD_DIR/bin/"
cp $gm_lib_path/bin/* $BUILD_DIR/bin/

mkdir -p $BUILD_DIR/.profile.d
echo "export PATH=\"\$HOME/bin:\$PATH\"" > $BUILD_DIR/.profile.d/graphicsmagick.sh
echo "export LD_LIBRARY_PATH=\"/app/vendor/graphicsmagick/lib/:\$LD_LIBRARY_PATH\"" >> $BUILD_DIR/.profile.d/graphicsmagick.sh

cat <<EOF > export
export PATH=$BUILD_DIR/bin:$PATH
EOF
