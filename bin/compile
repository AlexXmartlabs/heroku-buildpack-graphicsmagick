#!/bin/bash

set -e

source `dirname $0`/../configs.sh

# parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2
LP_DIR=`cd $(dirname $0); cd ..; pwd`

indent() {
  sed -u 's/^/       /'
}

arrow() {
  sed -u 's/^/-----> /'
}

echo "Installing graphicsmagick $GRAPHICS_MAGICK_VERSION" | arrow
# we need this directory, it's our destination
GM_VENDOR_DIR=$BUILD_DIR/vendor/graphicsmagick
rm -rf $GM_VENDOR_DIR/*
mkdir -p $GM_VENDOR_DIR

# We'll cache the build here
GM_SOURCE_DIR=$CACHE_DIR/graphicsmagick-$GRAPHICS_MAGICK_VERSION
GM_BUILD_DIR=$CACHE_DIR/graphicsmagick
mkdir -p $GM_BUILD_DIR

if [ "$GM_FORCE_REBUILD" = 'true' ] || [ -z "$(ls -L $GM_BUILD_DIR)" ] && [ -z "$(ls -L $GM_VENDOR_DIR)" ]
then
  echo "Building runtime environment for graphicsmagick" | arrow
  rm -rf $GM_BUILD_DIR
  rm -rf $GM_SOURCE_DIR
  mkdir -p $GM_SOURCE_DIR
  mkdir -p $GM_BUILD_DIR

  PACKAGE="https://downloads.sourceforge.net/project/graphicsmagick/graphicsmagick/$GRAPHICS_MAGICK_VERSION/GraphicsMagick-$GRAPHICS_MAGICK_VERSION.tar.gz"

  curl $PACKAGE -L -o - | tar xzf - -C $GM_SOURCE_DIR 2>&1 | indent
  cd $GM_SOURCE_DIR/GraphicsMagick-$GRAPHICS_MAGICK_VERSION

  echo "Building for the first time this will take a while." | indent
  ./configure --prefix=$GM_BUILD_DIR 2>&1 | indent
  make install 2>&1 | indent
fi

echo "Copying graphicsmagick binaries to vendor" | arrow

mkdir -p "$BUILD_DIR/bin/"
cp -R $GM_BUILD_DIR/. $GM_VENDOR_DIR
cp $GM_VENDOR_DIR/bin/* $BUILD_DIR/bin/

mkdir -p $BUILD_DIR/.profile.d
echo "export PATH=\"\$HOME/bin:\$PATH\"" > $BUILD_DIR/.profile.d/graphicsmagick.sh
echo "export LD_LIBRARY_PATH=\"/app/vendor/graphicsmagick/lib/:\$LD_LIBRARY_PATH\"" >> $BUILD_DIR/.profile.d/graphicsmagick.sh

cat <<EOF > export
export PATH=$BUILD_DIR/bin:$PATH
EOF
